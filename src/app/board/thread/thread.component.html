<div class="thread-container max-width">
  <div class="thread-header">
    <div class="thread-header-content">
      <h1 class="thread-header-title">Thread</h1>
      <span class="thread-header-subtitle"
        ># {{ channelsService.currentChannelName }}</span
      >
    </div>
    <button
      mat-icon-button
      aria-label="Close Thread"
      class="close-btn"
      (click)="closeThread()"
    >
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="thread-content">
    <!-- Originalnachricht -->
    <div
      class="thread-message-container"
      *ngIf="selectedMessage && !selectedMessage.isOwnMessage"
    >
      <img
        [src]="selectedMessage.senderAvatar"
        alt="Profile Image"
        class="avatar"
      />
      <div class="thread-message-details">
        <div class="thread-message-info">
          <span class="thread-message-sender">{{
            selectedMessage.senderName
          }}</span>
          <span class="thread-message-time">{{
            selectedMessage.formattedTimestamp
          }}</span>
        </div>
        <div class="thread-message-bubble">
          <p>{{ selectedMessage.message }}</p>
        </div>
        <div class="thread-show-reactions">
          <div
            class="thread-reaction-icon-button"
            *ngFor="let reaction of selectedMessage.reactions"
          >
            <div class="thread-reaction-name-popup">
              <span>{{ reaction.emoji }}</span>
              <h3>{{ reaction.senderName }}</h3>
              <span>Hat reagiert</span>
            </div>
            <span>{{ reaction.emoji }}</span>
            {{ reaction.count }}
          </div>
        </div>
      </div>
      <div class="emoji-box">
        <mat-icon
          (click)="showEmoji(selectedMessage.messageId)"
          class="message-icon"
          >add_reaction</mat-icon
        >
      </div>
    </div>

    <div style="width: 100%">
      <div
        class="thread-message-container user-message-container"
        *ngIf="selectedMessage && selectedMessage.isOwnMessage"
      >
        <img
          [src]="selectedMessage.senderAvatar"
          alt="Profile Image"
          class="avatar"
        />
        <div
          class="thread-message-details"
          *ngIf="!isEditing(selectedMessage.messageId)"
        >
          <div class="emoji-box user-emoji-box">
            <mat-icon
              class="message-icon"
              (click)="showEmoji(selectedMessage.messageId)"
              >add_reaction</mat-icon
            >
            <mat-icon class="message-icon" (click)="showMessageEditToggle()"
              >more_vert</mat-icon
            >
            <div *ngIf="showMessageEdit" class="thread-edit-message">
              <span
                (click)="
                  editMessage(selectedMessage.messageId, selectedMessage)
                "
                >Nachricht bearbeiten</span
              >
            </div>
          </div>
          <div class="user-message-info">
            <span class="thread-message-sender">{{
              selectedMessage.senderName
            }}</span>
            <span class="thread-message-time">{{
              selectedMessage.formattedTimestamp
            }}</span>
          </div>
          <div class="user-message-bubble">
            <p>{{ selectedMessage.message }}</p>
          </div>
          <div class="thread-show-reactions">
            <div
              class="thread-reaction-icon-button"
              *ngFor="let reaction of selectedMessage.reactions"
            >
              <div class="thread-reaction-name-popup">
                <span>{{ reaction.emoji }}</span>
                <h3>{{ reaction.senderName }}</h3>
                <span>Hat reagiert</span>
              </div>
              <span>{{ reaction.emoji }}</span>
              {{ reaction.count }}
            </div>
            <div>
              <mat-icon>add_reaction</mat-icon>
            </div>
          </div>
        </div>

        <div
          *ngIf="isEditing(selectedMessage.messageId)"
          class="thread-message-edit-container"
        >
          <textarea
            class="thread-edit-textarea"
            [(ngModel)]="selectedMessage.message"
          ></textarea>
          <div class="thread-message-edit-buttons">
            <div
              (click)="showEmoji(selectedMessage.messageId)"
              class="thread-message-icon"
            >
              <mat-icon fontIcon="sentiment_satisfied"></mat-icon>
            </div>
            <div class="thread-message-edit-action">
              <button (click)="cancelMessageEdit(selectedMessage)">
                Abbrechen
              </button>
              <button class="save-btn" (click)="saveMessage(selectedMessage)">
                Speichern
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Anzahl der Antworten -->
    <div class="answers">
      <span>{{ selectedMessage?.answers?.length }} Antworten</span>
      <div class="line"></div>
    </div>

    <!-- Kommentare -->
    <div *ngFor="let message of messages" style="width: 100%">
      <div class="thread-message-container" *ngIf="!message.isOwnMessage">
        <img [src]="message.senderAvatar" alt="Profile Image" class="avatar" />
        <div class="thread-message-details">
          <div class="emoji-box">
            <mat-icon
              class="message-icon"
              (click)="showEmoji(message.messageId)"
              >add_reaction</mat-icon
            >
          </div>
          <div class="thread-message-info">
            <span class="thread-message-sender">{{ message.senderName }}</span>
            <span class="thread-message-time">{{
              message.formattedTimestamp
            }}</span>
          </div>
          <div class="thread-message-bubble">
            <p class="thread-message-text">{{ message.message }}</p>
          </div>
          <div class="thread-show-reactions">
            <div
              class="thread-reaction-icon-button"
              *ngFor="let reaction of message.reactions"
            >
              <div class="thread-reaction-name-popup">
                <span>{{ reaction.emoji }}</span>
                <h3>{{ reaction.senderName }}</h3>
                <span>Hat reagiert</span>
              </div>
              <span>{{ reaction.emoji }}</span>
              {{ reaction.count }}
            </div>
            <div>
              <mat-icon>add_reaction</mat-icon>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Eigene Nachrichten -->
    <div *ngFor="let message of messages" style="width: 100%">
      <div
        class="thread-message-container user-message-container"
        *ngIf="message.isOwnMessage"
      >
        <img [src]="message.senderAvatar" alt="Profile Image" class="avatar" />
        <div
          class="thread-message-details"
          *ngIf="!isEditing(message.messageId)"
        >
          <div class="emoji-box user-emoji-box">
            <mat-icon
              class="message-icon"
              (click)="showEmoji(message.messageId)"
              >add_reaction</mat-icon
            >
            <mat-icon class="message-icon" (click)="showMessageEditToggle()"
              >more_vert</mat-icon
            >
            <div *ngIf="showMessageEdit" class="thread-edit-message">
              <span (click)="editMessage(message.messageId, message)"
                >Nachricht bearbeiten</span
              >
            </div>
          </div>
          <div class="user-message-info">
            <span class="thread-message-sender">{{ message.senderName }}</span>
            <span class="thread-message-time">{{
              message.formattedTimestamp
            }}</span>
          </div>
          <div class="user-message-bubble">
            <p>{{ message.message }}</p>
          </div>
          <div class="thread-show-reactions">
            <div
              class="thread-reaction-icon-button"
              *ngFor="let reaction of message.reactions"
            >
              <div class="thread-reaction-name-popup">
                <span>{{ reaction.emoji }}</span>
                <h3>{{ reaction.senderName }}</h3>
                <span>Hat reagiert</span>
              </div>
              <span>{{ reaction.emoji }}</span>
              {{ reaction.count }}
            </div>
            <div>
              <mat-icon>add_reaction</mat-icon>
            </div>
          </div>
        </div>

        <div
          *ngIf="isEditing(message.messageId)"
          class="thread-message-edit-container"
        >
          <textarea
            class="thread-edit-textarea"
            [(ngModel)]="message.message"
          ></textarea>
          <div class="thread-message-edit-buttons">
            <div
              (click)="showEmoji(message.messageId)"
              class="thread-message-icon"
            >
              <mat-icon fontIcon="sentiment_satisfied"></mat-icon>
            </div>
            <div class="thread-message-edit-action">
              <button (click)="cancelMessageEdit(message)">Abbrechen</button>
              <button class="save-btn" (click)="saveMessage(message)">
                Speichern
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Nachrichteneingabebereich -->
  <div class="thread-message-input-container">
    <textarea
      class="message-input"
      placeholder="Schreiben Sie Ihre Nachricht"
      [(ngModel)]="threadMessage"
      type="text"
    ></textarea>
    <div class="message-icon-container">
      <div class="left-icon-container">
        <input
          type="file"
          id="fileInput"
          (change)="onFileSelected($event)"
          hidden
        />
        <div class="message-icon" (click)="triggerFileInput()">
          <mat-icon fontIcon="add"></mat-icon>
        </div>
        <div class="separator"></div>
        <div class="thread-message-icon">
          <mat-icon
            (click)="showEmoji(threadMessage)"
            fontIcon="sentiment_satisfied"
          ></mat-icon>
        </div>
        <div class="message-icon">
          <mat-icon fontIcon="alternate_email"></mat-icon>
        </div>
        <div *ngIf="filePreviewUrl" class="file-preview">
          <img
            *ngIf="selectedFile && selectedFile.type.startsWith('image/')"
            [src]="filePreviewUrl"
            alt="Dateivorschau"
          />
          <a
            *ngIf="selectedFile && selectedFile.type === 'application/pdf'"
            [href]="filePreviewUrl"
            target="_blank"
            >PDF anzeigen</a
          >
          <mat-icon
            class="delete-upload"
            fontIcon="close"
            (click)="deleteUpload()"
          ></mat-icon>
        </div>
      </div>
      <div class="right-icon-container">
        <div class="message-icon send" (click)="sendMessage()">
          <mat-icon fontIcon="send"></mat-icon>
        </div>
      </div>
    </div>
    <emoji-mart
      *ngIf="showEmojiPicker"
      (emojiSelect)="addEmoji($event)"
      [darkMode]="false"
      title="Pick your emoji…"
      emoji="point_up"
    ></emoji-mart>
  </div>
</div>
